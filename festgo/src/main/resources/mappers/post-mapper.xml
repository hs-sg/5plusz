<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oplusz.festgo.repository.PostDao">

    <!-- 게시글 목록 조회 -->
    
    <select id="selectOrderByIdDesc" resultType="Post">
        SELECT * FROM post ORDER BY po_id DESC
    </select>
    
    <!-- 특정 게시글 조회( 조회수 증가 후 반환) -->
    
    <select id="selectById" parameterType="int" resultType="Post">
        SELECT * FROM post WHERE po_id = #{poId}
    </select>
    
    <!-- 조회수 증가 -->
    
    <update id="increaseViewCount" parameterType="int">
        UPDATE post SET po_views = po_views + 1 WHERE po_id = #{poId}
    </update>
    
    <!-- 게시글 생성 -->
    
     <insert id="insert" parameterType="PostCreateDto"  useGeneratedKeys="true"
        keyProperty="poId" keyColumn="po_id">
     
        INSERT INTO post (po_title, po_content, po_author, pc_id, po_created_time, po_modified_time)
        VALUES (#{poTitle}, #{poContent}, #{poAuthor}, #{pcId}, systimestamp, systimestamp)
    </insert>
   
    <!-- 첨부파일 저장 -->
    
    <insert id="insertAttachment" parameterType="java.util.List">
        INSERT INTO post_attachment (po_id, pa_attachments)
        VALUES 
        <foreach collection="list" item="attachment" separator=",">
            (#{attachment.poId}, #{attachment.paAttachments})
        </foreach>
    </insert>
    
    <!-- 첨부파일 조회  -->
    
    <select id="selectAttachmentsByPostId" resultType="PostAttachment">
    SELECT * FROM post_attachment WHERE po_id = #{poId}
    </select>
    
    <!-- 게시글 수정 -->
    
    <update id="update" parameterType="PostUpdateDto">
        UPDATE post 
        SET po_title = #{poTitle}, 
            po_content = #{poContent}, 
            po_modified_time = systimestamp
        WHERE po_id = #{poId}
    </update>
    
    <!-- 첨부파일 삭제 -->
    <delete id="deleteAttachmentsByIds" parameterType="java.util.Map">
        DELETE FROM post_attachment
        WHERE pa_id IN
        <foreach item="paId" collection="ids" open="(" separator="," close=")">
            #{paId}
        </foreach>
    </delete>
    
    <!-- 게시글 삭제 -->
    <delete id="deleteById" parameterType="java.lang.Integer">
        DELETE FROM post WHERE po_id = #{poId}
    </delete>
    
    <!-- 특정 게시글의 모든 첨부파일 삭제 (게시글 삭제 전 실행)-->
    <delete id="deleteAttachmentsByPostId" parameterType="java.lang.Integer">
        DELETE FROM post_attachment WHERE po_id = #{poId}
    </delete>
    
    <!-- 게시글 목록 조회 (페이징) -->
        <select id="selectPagedPosts" parameterType="map" resultType="com.oplusz.festgo.domain.Post">
                SELECT *
                FROM (
                    SELECT a.*, ROWNUM rnum
                    FROM (
                        SELECT *
                        FROM post
                        ORDER BY po_id DESC
                    ) a
                    WHERE ROWNUM &lt;= #{endRow}
                )
                WHERE rnum &gt; #{startRow}
            </select>

        
    <!-- 게시글 총 개수 조회 -->
        <select id="countPosts" resultType="int">
            SELECT COUNT(*) FROM post
        </select>
        
     <!-- 검색 및 페이징 처리 -->
     
        <select id="searchWithPaging" parameterType="map" resultType="com.oplusz.festgo.domain.Post">
            SELECT *
            FROM (
                SELECT A.*, ROWNUM AS rnum
                FROM (
                    SELECT *
                    FROM post
                    WHERE 1=1
                    <if test="category != null">
                        <choose>
                            <when test='category == "t"'>
                                AND po_title LIKE '%' || #{keyword} || '%'
                            </when>
                            <when test='category == "c"'>
                                AND po_content LIKE '%' || #{keyword} || '%'
                            </when>
                            <when test='category == "tc"'>
                                AND (po_title LIKE '%' || #{keyword} || '%' OR po_content LIKE '%' || #{keyword} || '%')
                            </when>
                            <when test='category == "a"'>
                                AND po_author LIKE '%' || #{keyword} || '%'
                            </when>
                        </choose>
                    </if>
                    ORDER BY po_id DESC
                ) A
                WHERE ROWNUM >= #{startRow} AND ROWNUM &lt;= #{endRow}
            )
        </select>





    <!-- 검색된 게시글 개수 -->
    
        <select id="countSearchResults" parameterType="map" resultType="int">
            SELECT COUNT(*) FROM post
            <where>
                <trim prefixOverrides="AND">
                    <if test="category != null and keyword != null">
                        <choose>
                            <when test='category == "t"'>
                                AND UPPER(po_title) LIKE '%' || UPPER(#{keyword}) || '%'
                            </when>
                            <when test='category == "c"'>
                                AND UPPER(po_content) LIKE '%' || UPPER(#{keyword}) || '%'
                            </when>
                            <when test='category == "tc"'>
                                AND (UPPER(po_title) LIKE '%' || UPPER(#{keyword}) || '%' 
                                     OR UPPER(po_content) LIKE '%' || UPPER(#{keyword}) || '%')
                            </when>
                            <when test='category == "a"'>
                                AND UPPER(po_author) LIKE '%' || UPPER(#{keyword}) || '%'
                            </when>
                        </choose>
                    </if>
                </trim>
            </where>
        </select>


    
</mapper>
